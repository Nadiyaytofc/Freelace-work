<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="utf-8">
    <title>Advanced Task System - Freelance Work</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
    <style>
        :root {
            --bg-color: #0b1220; 
            --card-bg: #0f172a;
            --accent-green: #22c55e; 
            --accent-blue: #38bdf8;
            --text-main: #e5e7eb;
            --text-muted: #94a3b8;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; }
        
        /* Dashboard Cards */
        .card { background: var(--card-bg); border-radius: 20px; padding: 25px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        
        /* Status Tags */
        .status-tag { font-size: 0.75rem; background: rgba(56, 189, 248, 0.15); padding: 5px 12px; border-radius: 50px; color: var(--accent-blue); font-weight: bold; margin-bottom: 15px; display: inline-block; }

        /* Buttons */
        .btn { border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; width: 100%; padding: 15px; font-size: 1rem; }
        .btn-play { background: var(--accent-blue); color: #000; }
        .btn-preparing { background: var(--accent-green); color: #fff; display: none; margin-top: 15px; }
        .btn-back { background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); margin-top: 15px; }

        /* Progress Animation */
        .progress-container { height: 10px; background: #1e293b; border-radius: 5px; margin: 20px 0; overflow: hidden; display: none; }
        .progress-bar { height: 100%; background: var(--accent-green); width: 0%; transition: 2.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Task List Item */
        .task-item { background: var(--card-bg); border-radius: 18px; padding: 20px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .task-item:hover { border-color: var(--accent-blue); }
        .btn-join { background: var(--accent-green); color: white; border: none; padding: 10px 22px; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 0.85rem; }
        .btn-join:disabled { background: #1e293b; color: var(--text-muted); cursor: not-allowed; }

        /* Upload Area */
        .upload-area { border: 2px dashed var(--accent-blue); padding: 25px; text-align: center; border-radius: 20px; margin-top: 20px; display: none; background: rgba(56, 189, 248, 0.03); }
        #imgPreview { width: 100%; max-height: 220px; object-fit: contain; margin-top: 15px; border-radius: 12px; display: none; border: 2px solid var(--card-bg); }
        
        .success-msg { display: none; text-align: center; color: var(--accent-green); animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container" id="loginView">
    <div class="card" style="text-align: center; background: #fff; color: #000; margin-top: 50px;">
        <span class="material-symbols-outlined" style="font-size: 48px; color: var(--bg-color);">account_circle</span>
        <h2 style="margin: 10px 0;">Task Panel Access</h2>
        <p style="color: #64748b; font-size: 0.85rem;">වැඩ ආරම්භ කිරීමට ඔබේ NIC අංකය ඇතුළත් කරන්න.</p>
        <input type="text" id="userNIC" placeholder="NIC Number (e.g. 1999XXXXXXX)" style="width:100%; padding:15px; margin:15px 0; border-radius:12px; border:1px solid #cbd5e1; font-size: 1rem; text-align: center;">
        <button class="btn" style="background:#000; color:#fff;" onclick="startTasks()">Login to Dashboard</button>
    </div>
</div>

<div class="container" id="mainView" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 id="activeNIC" style="color: var(--accent-blue); margin: 0;"></h3>
        <span style="font-size: 0.8rem; color: var(--text-muted);">Status: <b style="color:var(--accent-green)">Online</b></span>
    </div>
    <div class="card" style="padding: 15px; background: linear-gradient(90deg, #0f172a, #1e293b);">
        <p style="margin:0; font-size: 0.8rem; color: var(--text-muted);">Available Tasks for Today</p>
        <h2 style="margin: 5px 0; color: #fff;">Daily Job Market</h2>
    </div>
    <div id="taskList"></div>
</div>

<div class="container" id="taskStepView" style="display: none;">
    <div class="card">
        <span class="status-tag" id="taskStatus">පියවර 01: වෙබ් අඩවියට පිවිසීම</span>
        <h2 id="stepTitle" style="margin-bottom: 5px;">Task Title</h2>
        <p id="stepPrice" style="color: var(--accent-green); font-weight: bold; font-size: 1.3rem; margin-top: 0;"></p>
        
        <div id="instructionText">
            <p style="color: var(--text-muted); font-size: 0.95rem; line-height: 1.6;">පහත බටනය ඔබා අදාළ වෙබ් අඩවියට පිවිසෙන්න. එහිදී ලබාගත් Screenshot එකක් ගෙන නැවත මෙම පිටුවට (Back) පැමිණෙන්න.</p>
        </div>

        <button class="btn btn-play" id="playBtn" onclick="playTask()">
            <span class="material-symbols-outlined">ads_click</span> Task Play (Link එකට යන්න)
        </button>

        <div class="upload-area" id="uploadArea">
            <p style="color: var(--accent-blue); font-weight: bold; margin-bottom: 15px;">වැඩය අවසන්! දැන් Screenshot එක තෝරන්න.</p>
            <input type="file" id="taskFile" accept="image/*" onchange="previewAndShowPrep(event)" style="font-size: 0.8rem;">
            <img id="imgPreview">
        </div>

        <button class="btn btn-preparing" id="prepBtn" onclick="startPreparing()">
            <span class="material-symbols-outlined">forward</span> Preparing Task (දත්ත යවන්න)
        </button>

        <div class="progress-container" id="progContainer">
            <div class="progress-bar" id="progBar"></div>
        </div>

        <div class="success-msg" id="successMsg">
            <span class="material-symbols-outlined" style="font-size: 60px; color: var(--accent-green);">task_alt</span>
            <h3 style="margin-top: 10px;">Task Completed Successfully!</h3>
            <p style="color: var(--text-muted); font-size: 0.85rem;">ඔබගේ ගෙවීම් පද්ධතියට එක් කරන ලදී.</p>
        </div>

        <button class="btn btn-back" id="backBtn" onclick="goBack()" style="display: none;">
            <span class="material-symbols-outlined">arrow_back</span> Back to Task List
        </button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB01A6SNm1wW7YVDzHjNGFSZIZekMQ4Wo0",
        databaseURL: "https://frelance-work-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const IMGBB_API_KEY = "711ab8cc09ab1cd9d14c973336672921";
    
    const today = new Date().toISOString().split('T')[0];
    let currentUserNIC = "";
    let currentTask = null;
    let isTaskOpened = false;

    // Smart Focus Detection
    window.onfocus = function() {
        if (isTaskOpened) {
            isTaskOpened = false;
            document.getElementById('taskStatus').innerText = "පියවර 02: සාක්ෂි ඉදිරිපත් කිරීම";
            document.getElementById('playBtn').style.display = 'none';
            document.getElementById('instructionText').style.display = 'none';
            document.getElementById('uploadArea').style.display = 'block';
        }
    };

    function startTasks() {
        currentUserNIC = document.getElementById('userNIC').value.trim();
        if(!currentUserNIC) return alert("කරුණාකර NIC අංකය ඇතුළත් කරන්න");
        document.getElementById('loginView').style.display = 'none';
        document.getElementById('mainView').style.display = 'block';
        document.getElementById('activeNIC').innerText = "NIC: " + currentUserNIC;
        loadTasks();
    }

    async function loadTasks() {
        const list = document.getElementById('taskList');
        list.innerHTML = "<p style='text-align:center; color:var(--text-muted); padding:20px;'>Loading tasks...</p>";
        
        const history = await database.ref('task_history/' + currentUserNIC + '/' + today).once('value');
        const done = history.val() ? Object.keys(history.val()).map(Number) : [];

        // Tasks with Famous Site Links
        const tasksData = [
            { id: 1, title: "Google Search Activity | Task 01", price: "LKR 0.50", link: "https://www.google.com" },
            { id: 2, title: "YouTube Video Engagement | Task 02", price: "LKR 0.75", link: "https://www.youtube.com" },
            { id: 3, title: "Facebook Page Visit | Task 03", price: "LKR 0.40", link: "https://www.facebook.com" },
            { id: 4, title: "Instagram Profile Activity | Task 04", price: "LKR 0.60", link: "https://www.instagram.com" },
            { id: 5, title: "Official Website Visit | Task 05", price: "LKR 1.00", link: "https://www.wikipedia.org" }
        ];

        list.innerHTML = "";
        tasksData.forEach(t => {
            const isDone = done.includes(t.id);
            list.innerHTML += `
                <div class="task-item">
                    <div style="flex:1">
                        <h4 style="margin:0; font-size:0.9rem;">${t.title}</h4>
                        <span style="color:var(--accent-green); font-size:0.8rem; font-weight:bold;">${t.price}</span>
                    </div>
                    <button class="btn-join" ${isDone ? 'disabled' : `onclick="openTaskStep(${JSON.stringify(t).replace(/"/g, '&quot;')})"`}>
                        ${isDone ? 'Finished' : 'Join Task'}
                    </button>
                </div>`;
        });
    }

    function openTaskStep(task) {
        currentTask = task;
        isTaskOpened = false;
        document.getElementById('mainView').style.display = 'none';
        document.getElementById('taskStepView').style.display = 'block';
        document.getElementById('stepTitle').innerText = currentTask.title;
        document.getElementById('stepPrice').innerText = currentTask.price;
        
        // Reset UI Components
        document.getElementById('taskStatus').innerText = "පියවර 01: වෙබ් අඩවියට පිවිසීම";
        document.getElementById('playBtn').style.display = 'flex';
        document.getElementById('uploadArea').style.display = 'none';
        document.getElementById('prepBtn').style.display = 'none';
        document.getElementById('instructionText').style.display = 'block';
        document.getElementById('successMsg').style.display = 'none';
        document.getElementById('backBtn').style.display = 'none';
        document.getElementById('imgPreview').style.display = 'none';
        document.getElementById('taskFile').value = "";
    }

    function playTask() {
        window.open(currentTask.link, '_blank');
        isTaskOpened = true; 
    }

    function previewAndShowPrep(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = () => {
                const img = document.getElementById('imgPreview');
                img.src = reader.result;
                img.style.display = 'block';
                document.getElementById('prepBtn').style.display = 'flex';
                document.getElementById('taskStatus').innerText = "පියවර 03: අවසන් සැකසුම්";
            };
            reader.readAsDataURL(file);
        }
    }

    async function startPreparing() {
        const file = document.getElementById('taskFile').files[0];
        document.getElementById('prepBtn').style.display = 'none';
        document.getElementById('progContainer').style.display = 'block';
        document.getElementById('taskStatus').innerText = "Task දත්ත සකසමින් පවතී...";
        
        // Start Progress Bar Animation
        setTimeout(() => { document.getElementById('progBar').style.width = "100%"; }, 100);

        const formData = new FormData();
        formData.append("image", file);
        
        try {
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const data = await res.json();
            
            if(data.success) {
                // Save Completion to Firebase
                await database.ref('task_history/' + currentUserNIC + '/' + today + '/' + currentTask.id).set({
                    proof_url: data.data.url,
                    completion_time: new Date().toLocaleTimeString(),
                    status: "Completed",
                    payout: currentTask.price
                });

                // Display Final Success Screen after progress finishes
                setTimeout(() => {
                    document.getElementById('progContainer').style.display = 'none';
                    document.getElementById('uploadArea').style.display = 'none';
                    document.getElementById('successMsg').style.display = 'block';
                    document.getElementById('backBtn').style.display = 'flex';
                    document.getElementById('taskStatus').innerText = "සියල්ල සාර්ථකයි!";
                }, 2600);
            } else { alert("Image Upload Failed. Please try again."); resetPrepBtn(); }
        } catch(e) { 
            alert("Error connecting to server."); 
            resetPrepBtn();
        }
    }

    function resetPrepBtn() {
        document.getElementById('prepBtn').style.display = 'flex';
        document.getElementById('progContainer').style.display = 'none';
        document.getElementById('progBar').style.width = "0%";
    }

    function goBack() {
        document.getElementById('taskStepView').style.display = 'none';
        document.getElementById('mainView').style.display = 'block';
        loadTasks();
    }
</script>
</body>
        </html>
