<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support & Issues - BANK OF LK</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --accent: #00d2ff;
            --admin-gold: #ffcc00;
        }

        body {
            margin: 0; font-family: 'Poppins', sans-serif; min-height: 100vh;
            background: linear-gradient(-45deg, #0f172a, #1e293b, #0369a1, #0c4a6e);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            color: white; display: flex; flex-direction: column; align-items: center;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .top-nav { width: 100%; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .admin-trigger { background: var(--glass); border: 1px solid var(--admin-gold); color: var(--admin-gold); padding: 10px 25px; border-radius: 30px; cursor: pointer; backdrop-filter: blur(10px); font-weight: bold; }

        .action-container { display: flex; gap: 20px; margin: 40px 0; }
        .btn-action { background: var(--glass); border: 1px solid var(--glass-border); backdrop-filter: blur(15px); padding: 20px; border-radius: 20px; color: white; cursor: pointer; text-align: center; width: 180px; transition: 0.3s; }
        
        .form-panel { display: none; background: var(--glass); backdrop-filter: blur(20px); padding: 30px; border-radius: 25px; width: 90%; max-width: 500px; border: 1px solid var(--glass-border); margin-bottom: 40px; }
        input, textarea { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 12px; color: white; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }
        .submit-btn { background: var(--accent); border: none; padding: 12px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; color: #000; }

        .feed-container { width: 90%; max-width: 700px; margin-bottom: 50px; }
        .post-card { background: var(--glass); border: 1px solid var(--glass-border); padding: 20px; border-radius: 20px; margin-bottom: 20px; backdrop-filter: blur(10px); }
        .post-img { width: 100%; border-radius: 15px; margin-top: 15px; max-height: 350px; object-fit: cover; }

        .reply-box { background: rgba(0, 210, 255, 0.15); padding: 15px; border-radius: 12px; margin-top: 15px; border-left: 4px solid var(--accent); }
        .reply-btn-admin { background: #059669; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-size: 0.85rem; font-weight: bold; }

        #adminModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div class="top-nav">
    <h2>BANK OF LK <span style="font-weight: 300; color:var(--accent);">Support Hub</span></h2>
    <button class="admin-trigger" id="adminLogBtn" onclick="document.getElementById('adminModal').style.display='flex'">Admin Login</button>
</div>

<div class="action-container">
    <div class="btn-action" onclick="openForm('text')"><span class="material-symbols-outlined">description</span><br>පණිවිඩයක්</div>
    <div class="btn-action" onclick="openForm('image')"><span class="material-symbols-outlined">screenshot_region</span><br>රූපරාමු</div>
</div>

<div id="formPanel" class="form-panel">
    <h3 id="fTitle">වාර්තාව ඇතුළත් කරන්න</h3>
    <input type="text" id="uName" placeholder="ඔබේ නම">
    <textarea id="uMsg" rows="3" placeholder="විස්තරය..."></textarea>
    <div id="uImgArea" style="display:none;"><input type="file" id="uFile" accept="image/*" onchange="processImg()"></div>
    <button class="submit-btn" onclick="savePost()">පළ කරන්න</button>
</div>

<div class="feed-container" id="postFeed"></div>

<div id="adminModal">
    <div class="form-panel" style="display:block; width:280px; text-align:center;">
        <h3>Manager Access</h3>
        <input type="password" id="pCode" placeholder="Passcode">
        <button class="submit-btn" onclick="authAdmin()">Login</button>
        <p onclick="document.getElementById('adminModal').style.display='none'" style="cursor:pointer; font-size:0.8rem; margin-top:10px;">වසා දමන්න</p>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { databaseURL: "https://frelance-work-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let mode = 'text';
    let imgData = "";
    let isAdmin = false;
    let allData = {}; // දත්ත තාවකාලිකව තබා ගැනීමට

    function openForm(m) {
        mode = m;
        document.getElementById('formPanel').style.display = 'block';
        document.getElementById('uImgArea').style.display = (m === 'image' ? 'block' : 'none');
        document.getElementById('fTitle').innerText = (m === 'image' ? 'රූපරාමු සමඟ දෝෂය වාර්තා කරන්න' : 'පණිවිඩයක් ලියන්න');
    }

    function processImg() {
        const file = document.getElementById('uFile').files[0];
        const reader = new FileReader();
        reader.onloadend = () => { imgData = reader.result; };
        if(file) reader.readAsDataURL(file);
    }

    async function savePost() {
        const name = document.getElementById('uName').value;
        const msg = document.getElementById('uMsg').value;
        if(!name || !msg) return alert("කරුණාකර සියලු විස්තර ඇතුළත් කරන්න.");

        await db.ref('support_tickets').push({
            name, msg, img: (mode === 'image' ? imgData : ""),
            reply: "", time: Date.now()
        });
        document.getElementById('formPanel').style.display = 'none';
        alert("සාර්ථකව පළ කරන ලදී!");
    }

    // දත්ත නිරීක්ෂණය (Real-time update)
    db.ref('support_tickets').on('value', snap => {
        allData = snap.val();
        renderFeed();
    });

    // Feed එක Render කරන Function එක (මෙය Admin Login වූ විටත් නැවත ක්‍රියාත්මක වේ)
    function renderFeed() {
        const feed = document.getElementById('postFeed');
        feed.innerHTML = "";
        
        if(!allData) { feed.innerHTML = "<p style='text-align:center;'>තවම වාර්තා නැත.</p>"; return; }

        Object.keys(allData).reverse().forEach(id => {
            const p = allData[id];
            let replyContent = p.reply ? `<div class="reply-box"><strong>Admin Reply:</strong><br>${p.reply}</div>` : "";
            
            // වැදගත්: Admin ලෙස Login වී ඇත්නම් පමණක් Reply බොත්තම පෙන්වයි
            let adminBtn = isAdmin ? `<button class="reply-btn-admin" onclick="doReply('${id}')">Reply to User</button>` : "";

            feed.innerHTML += `
                <div class="post-card">
                    <div style="color:var(--accent); font-weight:bold;">@${p.name}</div>
                    <p style="margin:10px 0; color:#e2e8f0;">${p.msg}</p>
                    ${p.img ? `<img src="${p.img}" class="post-img">` : ""}
                    ${replyContent}
                    ${adminBtn}
                </div>
            `;
        });
    }

    function authAdmin() {
        const inputCode = document.getElementById('pCode').value;
        if(inputCode === "lkbankadmin") {
            isAdmin = true; // Admin සක්‍රීය කරයි
            document.getElementById('adminModal').style.display = 'none';
            document.getElementById('adminLogBtn').innerText = "Admin Active ✅";
            alert("Manager Access Granted! දැන් ඔබට පිළිතුරු දිය හැක.");
            renderFeed(); // Admin Status එක අනුව Feed එක නැවත පෙන්වයි
        } else {
            alert("වැරදි Passcode එකකි!");
        }
    }

    function doReply(id) {
        const rText = prompt("පාරිභෝගිකයාට ලබා දෙන පිළිතුර ඇතුළත් කරන්න:");
        if(rText) {
            db.ref('support_tickets/' + id).update({ reply: rText })
            .then(() => alert("පිළිතුර සාර්ථකව යවන ලදී!"));
        }
    }
</script>
</body>
</html>
