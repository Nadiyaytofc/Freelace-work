<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="utf-8">
    <title>Admin Dashboard - Freelance Work</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
    <style>
        :root {
            --bg: #0b1220;
            --card: #1e293b;
            --accent: #38bdf8;
            --text: #f8fafc;
            --muted: #94a3b8;
            --green: #22c55e;
            --red: #ef4444;
            --orange: #f59e0b;
        }

        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            padding: 20px; 
        }

        /* Login Overlay */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); display: flex; justify-content: center; align-items: center;
            z-index: 10000;
        }

        .login-box {
            background: var(--card); padding: 40px; border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center; width: 320px;
        }

        .container { max-width: 900px; margin: 0 auto; display: none; }

        h2 { color: var(--accent); margin-top: 30px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }

        .admin-card { 
            background: var(--card); padding: 20px; border-radius: 20px; 
            margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);
        }

        input, textarea { 
            width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; 
            border: 1px solid #334155; background: #0b1220; color: white; box-sizing: border-box;
        }

        button { 
            background: var(--accent); color: #000; border: none; padding: 12px; 
            border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px;
            transition: 0.3s;
        }

        .member-item {
            background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px;
            margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .member-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .kyc-img { width: 150px; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        .kyc-img:hover { transform: scale(1.05); }

        .member-info { flex: 1; min-width: 200px; font-size: 0.9rem; }
        .badge { display: inline-flex; align-items: center; font-size: 0.75rem; padding: 2px 8px; border-radius: 20px; margin-left: 5px; }
        .badge-verified { background: rgba(56, 189, 248, 0.2); color: var(--accent); }
        .badge-kyc { background: rgba(34, 197, 94, 0.2); color: var(--green); }

        .btn-sm { padding: 6px 12px; font-size: 0.75rem; width: auto; margin-right: 5px; }
        .btn-approve { background: var(--green); color: white; }
        .btn-reject { background: var(--red); color: white; }
        
        .status-tag { padding: 4px 10px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; }
        .pending { background: var(--orange); color: black; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <span class="material-symbols-outlined" style="font-size: 48px; color: var(--accent);">security</span>
        <h3>Admin Access</h3>
        <input type="password" id="adminIdInput" placeholder="Enter Admin ID">
        <button style="width:100%" onclick="checkLogin()">Login</button>
    </div>
</div>

<div class="container" id="adminContent">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2><span class="material-symbols-outlined">shield_person</span> Admin Panel</h2>
        <button class="btn-sm" style="background: var(--red); color: white;" onclick="location.reload()">Logout</button>
    </div>

    <div class="admin-card">
        <h3 style="margin-top:0"><span class="material-symbols-outlined">campaign</span> Notice Control</h3>
        <textarea id="noticeInput" placeholder="සාමාජිකයින්ට පෙන්විය යුතු පණිවිඩය..."></textarea>
        <button onclick="updateNotice()">Update Notice</button>
    </div>

    <h2><span class="material-symbols-outlined">id_card</span> KYC Requests</h2>
    <div id="kycRequestList">
        <p style="color: var(--muted);">Checking for requests...</p>
    </div>

    <h2><span class="material-symbols-outlined">group</span> Member Management</h2>
    <div id="memberList">
        <p style="color: var(--muted);">Loading members...</p>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB01A6SNm1wW7YVDzHjNGFSZIZekMQ4Wo0",
        databaseURL: "https://frelance-work-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function checkLogin() {
        if (document.getElementById('adminIdInput').value === "FW0001") {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            loadData();
        } else { alert("Access Denied!"); }
    }

    function loadData() {
        loadNotice();
        loadKYCRequests();
        loadMembers();
    }

    function loadNotice() {
        database.ref('admin_notice').on('value', (s) => {
            if (s.exists()) document.getElementById('noticeInput').value = s.val();
        });
    }

    function updateNotice() {
        database.ref('/').update({ admin_notice: document.getElementById('noticeInput').value })
        .then(() => alert("Notice Updated!"));
    }

    // --- KYC Logic ---
    function loadKYCRequests() {
        const kycDiv = document.getElementById('kycRequestList');
        database.ref('kyc_requests').on('value', (snapshot) => {
            kycDiv.innerHTML = "";
            const requests = snapshot.val();
            let count = 0;

            for (let nic in requests) {
                const req = requests[nic];
                if (req.status === "Pending") {
                    count++;
                    kycDiv.innerHTML += `
                        <div class="member-item">
                            <div class="member-info">
                                <b>NIC: ${nic}</b><br>
                                <small>Submitted: ${req.submittedAt}</small><br><br>
                                <a href="${req.nic_image}" target="_blank">
                                    <img src="${req.nic_image}" class="kyc-img" title="Click to expand">
                                </a>
                            </div>
                            <div class="edit-controls">
                                <button class="btn-sm btn-approve" onclick="handleKYC('${nic}', 'Approved')">Approve Identity</button>
                                <button class="btn-sm btn-reject" onclick="handleKYC('${nic}', 'Rejected')">Reject</button>
                            </div>
                        </div>`;
                }
            }
            if (count === 0) kycDiv.innerHTML = "<p style='color:var(--muted)'>No pending KYC requests.</p>";
        });
    }

    async function handleKYC(nic, status) {
        if (confirm(`Are you sure to ${status} this request?`)) {
            await database.ref('kyc_requests/' + nic).update({ status: status });
            if (status === 'Approved') {
                await database.ref('members/' + nic).update({ identity_verified: true });
            }
            alert("Request " + status);
        }
    }

    // --- Member Management ---
    function loadMembers() {
        const listDiv = document.getElementById('memberList');
        database.ref('members').on('value', (snapshot) => {
            listDiv.innerHTML = "";
            const data = snapshot.val();
            for (let nic in data) {
                const m = data[nic];
                const vBadge = m.verified ? '<span class="badge badge-verified"><span class="material-symbols-outlined" style="font-size:14px">verified</span> Verified</span>' : '';
                const iBadge = m.identity_verified ? '<span class="badge badge-kyc"><span class="material-symbols-outlined" style="font-size:14px">id_card</span> ID OK</span>' : '';
                
                listDiv.innerHTML += `
                    <div class="member-item">
                        <img src="${m.photo || 'https://via.placeholder.com/60'}" class="member-img">
                        <div class="member-info" id="info-${nic}">
                            <div><b class="v-name">${m.name}</b> ${vBadge} ${iBadge}</div>
                            <div>NIC: ${nic} | Bal: Rs. <span class="v-bal">${m.balance || 0}</span></div>
                        </div>
                        <div class="edit-controls">
                            <button class="btn-sm" style="background:var(--accent); color:black" onclick="toggleBlueTick('${nic}', ${m.verified || false})">Blue Tick</button>
                            <button class="btn-sm" onclick="enableEdit('${nic}')">Edit Bal</button>
                            <button class="btn-sm btn-approve" style="display:none" id="save-${nic}" onclick="saveEdit('${nic}')">Save</button>
                        </div>
                    </div>`;
            }
        });
    }

    async function toggleBlueTick(nic, status) {
        await database.ref('members/' + nic).update({ verified: !status });
    }

    function enableEdit(nic) {
        const balSpan = document.querySelector(`#info-${nic} .v-bal`);
        const currentBal = balSpan.innerText;
        balSpan.innerHTML = `<input type="text" id="inp-bal-${nic}" value="${currentBal}" style="width:60px; padding:2px; margin:0">`;
        document.getElementById(`save-${nic}`).style.display = "inline-block";
    }

    async function saveEdit(nic) {
        const newBal = document.getElementById(`inp-bal-${nic}`).value;
        await database.ref('members/' + nic).update({ balance: newBal });
        alert("Balance Updated!");
    }
</script>

</body>
</html>
